name: ğŸ§± Registrar nÃºmero do deploy (GitHub Pages)

on:
  workflow_run:
    workflows: ["pages-build-deployment"]
    types:
      - completed

permissions:
  contents: write

jobs:
  registrar-deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Clonar repositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Verificar se hÃ¡ commit novo
        id: verificar
        run: |
          COMMIT_DEPLOY=${{ github.event.workflow_run.head_sha }}
          COMMIT_CURTO=$(echo "${COMMIT_DEPLOY}" | cut -c1-7)
          echo "ğŸ§¾ Commit do deploy: ${COMMIT_CURTO}"

          if git log -1 --pretty=format:'%H' | grep -q "$COMMIT_DEPLOY"; then
            echo "mesmo_commit=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Mesmo commit detectado, nÃ£o hÃ¡ deploy novo."
          else
            echo "mesmo_commit=false" >> $GITHUB_OUTPUT
            echo "âœ… Novo commit detectado, gerando registro."
          fi

      - name: ğŸ•’ Gerar version.json e atualizar histÃ³rico (new.json)
        if: steps.verificar.outputs.mesmo_commit == 'false'
        run: |
          BUILD=$(date +'%Y%m%d%H%M')
          DATA=$(TZ='America/Sao_Paulo' date +'%d/%m/%Y, %Hh%Mmin')
          DEPLOY_NUM=${{ github.event.workflow_run.run_number }}
          AUTOR="GitHub Pages"
          MENSAGEM="Deploy automÃ¡tico concluÃ­do com sucesso"
          COMMIT_DEPLOY=${{ github.event.workflow_run.head_sha }}

          # Cria o version.json (Ãºltimo deploy)
          echo "{" > version.json
          echo "  \"build\": \"${BUILD}\"," >> version.json
          echo "  \"data\": \"${DATA}\"," >> version.json
          echo "  \"autor\": \"${AUTOR}\"," >> version.json
          echo "  \"mensagem\": \"${MENSAGEM}\"," >> version.json
          echo "  \"execucao\": \"${DEPLOY_NUM}\"," >> version.json
          echo "  \"branch\": \"gh-pages\"," >> version.json
          echo "  \"commit\": \"${COMMIT_DEPLOY}\"" >> version.json
          echo "}" >> version.json

          echo "ğŸ“¦ version.json gerado:"
          cat version.json

          # Atualiza histÃ³rico cumulativo
          if [ -f new.json ]; then
            echo "ğŸ“œ Atualizando histÃ³rico existente..."
            jq ". + [$(cat version.json)]" new.json > temp.json && mv temp.json new.json
          else
            echo "ğŸ“œ Criando novo arquivo de histÃ³rico..."
            echo "[$(cat version.json)]" > new.json
          fi

          echo "ğŸ“š HistÃ³rico atualizado:"
          cat new.json

      - name: ğŸ’¾ Commit e Push
        if: steps.verificar.outputs.mesmo_commit == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Action (Deploy)"
          git config user.email "actions@github.com"
          git add version.json new.json
          git commit -m "ğŸ§± HistÃ³rico atualizado: Deploy #${{ github.event.workflow_run.run_number }}" || echo "Sem alteraÃ§Ãµes"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}

      - name: ğŸ” Log final
        run: |
          echo "âœ… Registro concluÃ­do!"
          echo "Deploy #: ${{ github.event.workflow_run.run_number }}"
          echo "Commit: ${{ github.event.workflow_run.head_sha }}"
          echo "HorÃ¡rio de BrasÃ­lia: $(TZ='America/Sao_Paulo' date)"
