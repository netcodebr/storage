name: ðŸ§± Registrar nÃºmero do deploy (GitHub Pages)

on:
  workflow_run:
    workflows: ["pages-build-deployment"]
    types:
      - completed

permissions:
  contents: write

jobs:
  registrar-deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }} # âœ… sÃ³ executa se o deploy teve sucesso
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Clonar repositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Verificar se hÃ¡ commit novo
        id: verificar
        run: |
          COMMIT=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)
          if git log -1 --pretty=format:'%H' | grep -q "$COMMIT"; then
            echo "mesmo_commit=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Mesmo commit detectado, nÃ£o hÃ¡ deploy novo."
          else
            echo "mesmo_commit=false" >> $GITHUB_OUTPUT
            echo "âœ… Novo commit detectado, gerando versÃ£o."
          fi

      - name: ðŸ•’ Gerar version.json (somente se for commit novo)
        if: steps.verificar.outputs.mesmo_commit == 'false'
        run: |
          BUILD=$(date +'%Y%m%d%H%M')
          DATA=$(TZ='America/Sao_Paulo' date +'%d/%m/%Y, %Hh%Mmin')
          DEPLOY_NUM=${{ github.event.workflow_run.run_number }}
          AUTOR="GitHub Pages"
          MENSAGEM="Deploy automÃ¡tico concluÃ­do com sucesso"

          echo "{" > version.json
          echo "  \"build\": \"${BUILD}\"," >> version.json
          echo "  \"data\": \"${DATA}\"," >> version.json
          echo "  \"autor\": \"${AUTOR}\"," >> version.json
          echo "  \"mensagem\": \"${MENSAGEM}\"," >> version.json
          echo "  \"execucao\": \"${DEPLOY_NUM}\"," >> version.json
          echo "  \"branch\": \"gh-pages\"" >> version.json
          echo "}" >> version.json

          echo "ðŸ“¦ version.json gerado:"
          cat version.json

      - name: ðŸ’¾ Commit e Push (somente se for commit novo)
        if: steps.verificar.outputs.mesmo_commit == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Action (Deploy)"
          git config user.email "actions@github.com"
          git add version.json
          git commit -m "ðŸš€ Deploy registrado (GitHub Pages #${{ github.event.workflow_run.run_number }})" || echo "Sem alteraÃ§Ãµes"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}

      - name: âœ… FinalizaÃ§Ã£o
        run: |
          echo "ðŸŽ‰ Workflow finalizado!"
          echo "Deploy detectado: #${{ github.event.workflow_run.run_number }}"
          echo "HorÃ¡rio de BrasÃ­lia: $(TZ='America/Sao_Paulo' date)"
