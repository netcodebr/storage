name: ðŸ§± Registrar nÃºmero do deploy (GitHub Pages)

on:
  workflow_run:
    workflows: ["pages-build-deployment"]  # Escuta o deploy oficial do GitHub Pages
    types:
      - completed

permissions:
  contents: write

jobs:
  registrar-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Clonar repositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ•’ Gerar version.json com nÃºmero real do deploy
        run: |
          BUILD=$(date +'%Y%m%d%H%M')
          DATA=$(TZ='America/Sao_Paulo' date +'%d/%m/%Y, %Hh%Mmin')
          DEPLOY_NUM=${{ github.event.workflow_run.run_number }}
          AUTOR="GitHub Pages"
          MENSAGEM="Deploy automÃ¡tico concluÃ­do com sucesso"

          echo "{" > version.json
          echo "  \"build\": \"${BUILD}\"," >> version.json
          echo "  \"data\": \"${DATA}\"," >> version.json
          echo "  \"autor\": \"${AUTOR}\"," >> version.json
          echo "  \"mensagem\": \"${MENSAGEM}\"," >> version.json
          echo "  \"execucao\": \"${DEPLOY_NUM}\"," >> version.json
          echo "  \"branch\": \"gh-pages\"" >> version.json
          echo "}" >> version.json

          echo "ðŸ“¦ version.json gerado:"
          cat version.json

      - name: ðŸ’¾ Commit e Push do version.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Action (Deploy)"
          git config user.email "actions@github.com"
          git add version.json
          git commit -m "ðŸš€ Deploy registrado (GitHub Pages #${{ github.event.workflow_run.run_number }})" || echo "Sem alteraÃ§Ãµes"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}

      - name: âœ… Log de confirmaÃ§Ã£o
        run: |
          echo "ðŸŽ‰ Deploy detectado com sucesso!"
          echo "ðŸ”¢ NÃºmero do deploy: #${{ github.event.workflow_run.run_number }}"
          echo "ðŸ•’ HorÃ¡rio de BrasÃ­lia: $(TZ='America/Sao_Paulo' date)"
          echo "ðŸ“‚ Arquivo version.json atualizado."
