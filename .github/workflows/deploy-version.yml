name: ðŸ§± Registrar nÃºmero do deploy (GitHub Pages)

on:
  workflow_run:
    workflows: ["pages-build-deployment"]
    types: [completed]

permissions:
  contents: write

jobs:
  registrar-deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout (branch padrÃ£o)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}
          fetch-depth: 0

      - name: ðŸ§© Instalar jq (manipular JSON)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: ðŸ”Ž Definir variÃ¡veis do deploy
        id: vars
        run: |
          BUILD=$(date +'%Y%m%d%H%M')
          DATA=$(TZ='America/Sao_Paulo' date +'%d/%m/%Y, %Hh%Mmin (HorÃ¡rio de BrasÃ­lia)')
          DEPLOY_NUM=${{ github.event.workflow_run.run_number }}
          COMMIT_DEPLOY=${{ github.event.workflow_run.head_sha }}
          COMMIT_CURTO=$(echo "${COMMIT_DEPLOY}" | cut -c1-7)
          URL_DEPLOY="https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}"

          echo "build=${BUILD}" >> $GITHUB_OUTPUT
          echo "data=${DATA}" >> $GITHUB_OUTPUT
          echo "deploy_num=${DEPLOY_NUM}" >> $GITHUB_OUTPUT
          echo "commit=${COMMIT_DEPLOY}" >> $GITHUB_OUTPUT
          echo "commit_curto=${COMMIT_CURTO}" >> $GITHUB_OUTPUT
          echo "url=${URL_DEPLOY}" >> $GITHUB_OUTPUT

          echo "ðŸ§± Deploy #${DEPLOY_NUM} â€” commit ${COMMIT_CURTO}"

      - name: ðŸš§ Verificar Ãºltimo commit registrado no histÃ³rico
        id: check
        run: |
          if [ -f new.json ] && [ -s new.json ]; then
            LAST_COMMIT=$(jq -r '.[-1].commit // empty' new.json)
          else
            LAST_COMMIT=""
          fi
          echo "last_commit=${LAST_COMMIT}" >> $GITHUB_OUTPUT
          if [ "${LAST_COMMIT}" = "${{ steps.vars.outputs.commit }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Mesmo commit jÃ¡ registrado (${LAST_COMMIT}). Nada a fazer."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "âœ… Commit novo detectado: ${{ steps.vars.outputs.commit_curto }}"
          fi

      - name: ðŸ•’ Gerar version.json (Ãºltima versÃ£o)
        if: steps.check.outputs.skip == 'false'
        run: |
          cat > version.json <<JSON
          {
            "build": "${{ steps.vars.outputs.build }}",
            "data": "${{ steps.vars.outputs.data }}",
            "autor": "GitHub Pages",
            "mensagem": "Deploy automÃ¡tico concluÃ­do com sucesso",
            "execucao": "${{ steps.vars.outputs.deploy_num }}",
            "branch": "gh-pages",
            "commit": "${{ steps.vars.outputs.commit }}",
            "url": "${{ steps.vars.outputs.url }}"
          }
          JSON
          echo "ðŸ“¦ version.json:"
          cat version.json

      - name: ðŸ“š Atualizar histÃ³rico cumulativo (new.json)
        if: steps.check.outputs.skip == 'false'
        run: |
          if [ -f new.json ] && [ -s new.json ]; then
            jq ". + [$(cat version.json)]" new.json > tmp.json && mv tmp.json new.json
          else
            echo "[$(cat version.json)]" > new.json
          fi
          echo "ðŸ“š new.json atualizado:"
          tail -n +1 new.json

      - name: ðŸ’¾ Commit e Push
        if: steps.check.outputs.skip == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Action (Deploy)"
          git config user.email "actions@github.com"
          git add version.json new.json
          git commit -m "ðŸ§± HistÃ³rico atualizado: Deploy #${{ steps.vars.outputs.deploy_num }} (commit ${{ steps.vars.outputs.commit_curto }})" || echo "Sem alteraÃ§Ãµes"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.event.repository.default_branch }}

      - name: âœ… Log final
        run: |
          echo "âœ… Finalizado."
          echo "Deploy #: ${{ steps.vars.outputs.deploy_num }}"
          echo "Commit:  ${{ steps.vars.outputs.commit }}"
          echo "URL:     ${{ steps.vars.outputs.url }}"
          echo "Hora BR: $(TZ='America/Sao_Paulo' date)"
