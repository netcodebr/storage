name: ğŸš€ Gerar versÃ£o automÃ¡tica completa para o PWA

on:
  push:
    branches:
      - main  # altere para 'master' se seu branch principal for esse

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Clonar repositÃ³rio completo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NecessÃ¡rio para obter histÃ³rico de commits

      - name: ğŸªµ Log de auditoria
        run: |
          echo "ğŸ§± Build iniciada em $(TZ='America/Sao_Paulo' date +'%d/%m/%Y %H:%M:%S')"
          echo "ğŸ‘¤ Autor do commit: $(git log -1 --pretty=format:'%an')"
          echo "ğŸ’¬ Mensagem do commit: $(git log -1 --pretty=format:'%s')"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ”¢ ExecuÃ§Ã£o: ${{ github.run_number }}"

      - name: ğŸ•’ Gerar version.json com dados detalhados
        run: |
          BUILD=$(date +'%Y%m%d%H%M')
          DATA=$(TZ='America/Sao_Paulo' date +'%d/%m/%Y, %Hh%Mmin')
          AUTOR=$(git log -1 --pretty=format:'%an')
          MENSAGEM=$(git log -1 --pretty=format:'%s')
          EXECUCAO=${{ github.run_number }}
          BRANCH=${{ github.ref_name }}

          echo "{" > version.json
          echo "  \"build\": \"${BUILD}\"," >> version.json
          echo "  \"data\": \"${DATA}\"," >> version.json
          echo "  \"autor\": \"${AUTOR}\"," >> version.json
          echo "  \"mensagem\": \"${MENSAGEM}\"," >> version.json
          echo "  \"execucao\": \"${EXECUCAO}\"," >> version.json
          echo "  \"branch\": \"${BRANCH}\"" >> version.json
          echo "}" >> version.json

          echo "ğŸ“¦ version.json gerado:"
          cat version.json

      - name: ğŸ’¾ Commit e Push do version.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"
          git add version.json
          git commit -m "ğŸ§± VersÃ£o automÃ¡tica atualizada: $(TZ='America/Sao_Paulo' date +'%Y-%m-%d %H:%M:%S')" || echo "Sem alteraÃ§Ãµes"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}

      - name: âœ… FinalizaÃ§Ã£o
        run: |
          echo "ğŸ‰ VersÃ£o gerada com sucesso!"
          echo "ğŸ“¦ Build: $(date +'%Y%m%d%H%M')"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ”¢ ExecuÃ§Ã£o: ${{ github.run_number }}"
          echo "ğŸ•’ HorÃ¡rio de BrasÃ­lia: $(TZ='America/Sao_Paulo' date)"
