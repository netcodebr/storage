name: ðŸ§± Atualizar histÃ³rico de builds (new.json)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  version:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Clonar repositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ•’ Atualizar histÃ³rico new.json
        run: |
          echo "â³ Gerando histÃ³rico..."
          BUILD=$(date +'%Y%m%d%H%M')
          DATA=$(TZ='America/Sao_Paulo' date +'%d/%m/%Y, %Hh%Mmin (HorÃ¡rio de BrasÃ­lia)')
          AUTOR=$(git log -1 --pretty=format:'%an')
          MENSAGEM=$(git log -1 --pretty=format:'%s')

          # Cria o arquivo se nÃ£o existir
          if [ ! -f new.json ]; then
            echo "[]" > new.json
          fi

          # Adiciona novo registro no topo
          jq --arg b "$BUILD" \
             --arg d "$DATA" \
             --arg a "$AUTOR" \
             --arg m "$MENSAGEM" \
             '. = [{build: $b, data: $d, autor: $a, mensagem: $m}] + .' new.json > tmp.$$.json && mv tmp.$$.json new.json

          echo "âœ… HistÃ³rico atualizado:"
          tail -n 20 new.json

      - name: ðŸ’¾ Commit e Push do histÃ³rico
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"
          git add new.json
          git commit -m "ðŸ§± HistÃ³rico atualizado: $(TZ='America/Sao_Paulo' date +'%d/%m/%Y %H:%M')" || echo "Sem alteraÃ§Ãµes"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}
