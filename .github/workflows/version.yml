name: ðŸ§± Atualizar versÃ£o e histÃ³rico (version.json + new.json)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  version:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Clonar repositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ•’ Gerar version.json e atualizar new.json
        id: gerar
        run: |
          echo "â³ Gerando versÃ£o..."
          BUILD=$(date +'%Y%m%d%H%M')
          DATA=$(TZ='America/Sao_Paulo' date +'%d/%m/%Y, %Hh%Mmin')
          AUTOR=$(git log -1 --pretty=format:'%an')
          MENSAGEM=$(git log -1 --pretty=format:'%s')
          EXECUCAO=${{ github.run_number }}
          BRANCH=${{ github.ref_name }}

          # Exporta para prÃ³ximos passos
          echo "BUILD=${BUILD}" >> $GITHUB_OUTPUT
          echo "DATA=${DATA}" >> $GITHUB_OUTPUT
          echo "MENSAGEM=${MENSAGEM}" >> $GITHUB_OUTPUT

          # Cria version.json (Ãºltima versÃ£o)
          cat <<JSON > version.json
          {
            "build": "${BUILD}",
            "data": "${DATA}",
            "autor": "${AUTOR}",
            "mensagem": "${MENSAGEM}",
            "execucao": "${EXECUCAO}",
            "branch": "${BRANCH}"
          }
          JSON
          echo "âœ… version.json criado:"
          cat version.json

          # Cria histÃ³rico se nÃ£o existir
          if [ ! -f new.json ]; then
            echo "[]" > new.json
          fi

          # Adiciona novo registro ao topo do histÃ³rico
          jq --arg b "$BUILD" \
             --arg d "$DATA" \
             --arg a "$AUTOR" \
             --arg m "$MENSAGEM" \
             --arg e "$EXECUCAO" \
             --arg br "$BRANCH" \
             '. = [{build: $b, data: $d, autor: $a, mensagem: $m, execucao: $e, branch: $br}] + .' new.json > tmp.$$.json && mv tmp.$$.json new.json

          echo "ðŸ“˜ new.json atualizado (Ãºltimas linhas):"
          tail -n 20 new.json

      - name: ðŸ’¾ Commit e Push (com data e mensagem)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATA_ATUAL="${{ steps.gerar.outputs.DATA }}"
          MSG_ATUAL="${{ steps.gerar.outputs.MENSAGEM }}"
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"
          git add version.json new.json
          git commit -m "ðŸ§± VersÃ£o registrada em ${DATA_ATUAL} â€” ${MSG_ATUAL}" || echo "Sem alteraÃ§Ãµes"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}
