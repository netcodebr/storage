name: ğŸ§± Atualizar versÃ£o e histÃ³rico (version.json + new.json)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  version:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Clonar repositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ•’ Gerar version.json e atualizar new.json
        run: |
          echo "â³ Gerando versÃ£o..."
          BUILD=$(date +'%Y%m%d%H%M')
          DATA=$(TZ='America/Sao_Paulo' date +'%d/%m/%Y, %Hh%Mmin')
          AUTOR=$(git log -1 --pretty=format:'%an')
          MENSAGEM=$(git log -1 --pretty=format:'%s')
          EXECUCAO=${{ github.run_number }}
          BRANCH=${{ github.ref_name }}

          # Cria o version.json no formato desejado
          cat <<JSON > version.json
          {
            "build": "${BUILD}",
            "data": "${DATA}",
            "autor": "${AUTOR}",
            "mensagem": "${MENSAGEM}",
            "execucao": "${EXECUCAO}",
            "branch": "${BRANCH}"
          }
          JSON

          echo "âœ… version.json criado:"
          cat version.json

          # Cria histÃ³rico se nÃ£o existir
          if [ ! -f new.json ]; then
            echo "[]" > new.json
          fi

          # Adiciona novo registro ao topo do histÃ³rico
          jq --arg b "$BUILD" \
             --arg d "$DATA" \
             --arg a "$AUTOR" \
             --arg m "$MENSAGEM" \
             --arg e "$EXECUCAO" \
             --arg br "$BRANCH" \
             '. = [{build: $b, data: $d, autor: $a, mensagem: $m, execucao: $e, branch: $br}] + .' new.json > tmp.$$.json && mv tmp.$$.json new.json

          echo "ğŸ“˜ new.json atualizado (Ãºltimas entradas):"
          tail -n 20 new.json

      - name: ğŸ’¾ Commit e Push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"
          git add version.json new.json
          git commit -m "ğŸ§± VersÃ£o ${BUILD} registrada em ${DATA}" || echo "Sem alteraÃ§Ãµes"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}
